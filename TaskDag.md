-- BELOW IS A TASK DAG USING A STREAM TO TRIGGER PROCEDURES
-- BELOW THE IMAGE ARE THE COMMANDS FOR CREATING THE TASKS THEMSELVES

<img width="2077" height="797" alt="image" src="https://github.com/user-attachments/assets/54069418-9365-4d50-9977-0387900f5294" />



CREATE TASK IF NOT EXISTS GENERAL_HOSPITAL_PATIENTS.ADMIN_HEALTHCARE_PATIENT_DATA_INGEST_START
    WITH TAG (DATA_GOVERNANCE.COSTING_TAGS.ENVIRONMENT = 'DEVELOPMENT',
              DATA_GOVERNANCE.COSTING_TAGS.JOB_ID = 'HEALTHCARE_PROJECT',
              DATA_GOVERNANCE.COSTING_TAGS.TASK_ID = 'HEALTHCARE_PATIENT_DATA_INGEST_START') 
    SCHEDULE = 'USING CRON */5 * * * * America/Denver'
    WHEN SYSTEM$STREAM_HAS_DATA('GENERAL_HOSPITAL_PATIENTS.INBOUND_HEALTHCARE_FILES_STREAM')
        AS 
            SELECT TRUE;

        
CREATE TASK IF NOT EXISTS GENERAL_HOSPITAL_PATIENTS.ADMIN_HEALTHCARE_PATIENT_DATA_INGEST_TRIGGER_RESET
    WITH TAG (DATA_GOVERNANCE.COSTING_TAGS.ENVIRONMENT = 'DEVELOPMENT',
              DATA_GOVERNANCE.COSTING_TAGS.JOB_ID = 'HEALTHCARE_PROJECT',
              DATA_GOVERNANCE.COSTING_TAGS.TASK_ID = 'HEALTHCARE_PATIENT_DATA_INGEST_TRIGGER_RESET') 
    WAREHOUSE = 'COMPUTE_WH'
    AFTER GENERAL_HOSPITAL_PATIENTS.ADMIN_HEALTHCARE_PATIENT_DATA_INGEST_START
    AS
        CREATE OR REPLACE TEMPORARY TABLE GENERAL_HOSPITAL_PATIENTS.ADMIN_HEALTHCARE_PATIENT_DATA_INGEST_TRIGGER_RESET
            AS
                SELECT * FROM GENERAL_HOSPITAL_PATIENTS.INBOUND_HEALTHCARE_FILES_STREAM;


CREATE TASK IF NOT EXISTS GENERAL_HOSPITAL_PATIENTS.CALL_CREATE_SCHEMA_AND_TABLES
    WITH TAG (DATA_GOVERNANCE.COSTING_TAGS.ENVIRONMENT = 'DEVELOPMENT',
              DATA_GOVERNANCE.COSTING_TAGS.JOB_ID = 'HEALTHCARE_PROJECT',
              DATA_GOVERNANCE.COSTING_TAGS.TASK_ID = 'CALL_CREATE_SCHEMA_AND_TABLES') 
    WAREHOUSE = 'COMPUTE_WH'
    AFTER GENERAL_HOSPITAL_PATIENTS.ADMIN_HEALTHCARE_PATIENT_DATA_INGEST_START
    AS
        CALL GENERAL_HOSPITAL_PATIENTS.CREATE_SCHEMA_AND_TABLES('GENERAL_HOSPITAL_PATIENTS');
        SELECT TRUE;
        
                
CREATE TASK IF NOT EXISTS GENERAL_HOSPITAL_PATIENTS.CALL_LOAD_DATA_FROM_FILES
    WITH TAG (DATA_GOVERNANCE.COSTING_TAGS.ENVIRONMENT = 'DEVELOPMENT',
              DATA_GOVERNANCE.COSTING_TAGS.JOB_ID = 'HEALTHCARE_PROJECT',
              DATA_GOVERNANCE.COSTING_TAGS.TASK_ID = 'CALL_LOAD_DATA_FROM_FILES') 
    WAREHOUSE = 'COMPUTE_WH'
    AFTER GENERAL_HOSPITAL_PATIENTS.CALL_CREATE_SCHEMA_AND_TABLES
    AS
        CALL GENERAL_HOSPITAL_PATIENTS.LOAD_DATA_FROM_FILES('GENERAL_HOSPITAL_PATIENTS');
        

CREATE TASK IF NOT EXISTS GENERAL_HOSPITAL_PATIENTS.CALL_MERGE_DATA_TO_PATIENT_MASTER_TABLE
    WITH TAG (DATA_GOVERNANCE.COSTING_TAGS.ENVIRONMENT = 'DEVELOPMENT',
              DATA_GOVERNANCE.COSTING_TAGS.JOB_ID = 'HEALTHCARE_PROJECT',
              DATA_GOVERNANCE.COSTING_TAGS.TASK_ID = 'CALL_MERGE_DATA_TO_PATIENT_MASTER_TABLE') 
    WAREHOUSE = 'COMPUTE_WH'
    AFTER GENERAL_HOSPITAL_PATIENTS.CALL_LOAD_DATA_FROM_FILES
    AS
        CALL MERGE_DATA_TO_PATIENT_MASTER_TABLE();        

